

# 第19届全国大学生智能汽车竞赛 百度创意组
淮阴师范学院 计算机科学与技术学院 机器人创新实验室 HNU-WALL-E 上位机代码

本方案基于鲸鱼官方小车和Jetson orin nano 8GB修改开发。

这次比赛有些遗憾，由于第二轮场地测试不足，小车在比赛中出现了一些意外，未能满分完赛。赛后我们决定开源，但是考虑到我们学校目前积累不足，需要给后续成员留点东西，所以只描述方案并开源部分代码。

[演示视频](https://www.bilibili.com/video/BV1TJpqeNEdk/)

------

# 目录说明

`collect_wrap/base/remote_control.py`: 添加了巡航采集可从上一次结尾处继续，定点采集，识别数据采集等功能；

`ernie_bot`: 文心大模型；

`paddle_jetson`: 巡航推理前添加提取车道线(传统与语义分割)，对人物属性识别与文本识别做了一点修改；

`tools`: 添加多线程操作；

`vehicle`: 统一移动单位，添加智能舵机平滑移动，修改抓夹舵机映射到张开后两爪间距；

`car_positioning.py`: 定位脚本；

`car_start_back_as.py`: 监控脚本；

`car_wrap.py`: 添加多个巡航pid，修改动作执行等；

`car_start.py`、`task_func.py`、`config_task.yml`: 非最终版本代码；

------

# 环境配置
## 拉取`docker`镜像
```bash
docker pull ryzquo/envs:bd19_l4t_r1
```

## 启动容器`bd19_l4t`
```bash
sudo docker run -it \
-v ~/docker/bd19/:/root/bd19/ \
-v /dev:/dev \
-v /etc/udev:/etc/udev \
--device=/dev/video0 \
--device=/dev/video1 \
--device=/dev/video2 \
--device=/dev/video3 \
--device=/dev/ttyUSB0 \
--runtime=nvidia \
--gpus=all \
--network=host \
--name bd19_l4t \
ryzquo/envs:bd19_l4t_r1
```

## 设置开机自启
> 因为不想再修改镜像，所以编写了一个监控脚本来控制小车启动，并且可以和按钮处逻辑配合支持重启
>

给docker容器设置自启动

```bash
docker update --restart=always 容器名或者id
```

在`~/.bashrc`添加即可

```plain
nohup python3 项目路径/car_start_back_as.py --op start > output.log 2>&1 < /dev/null &
```

------

# 方案说明
> 小车整体使用巡航时异步执行机械臂动作的逻辑以节省时间
>

## 巡航
巡航部分我们采用提取车道线后使用cnn训练巡航模型的方案；

### 提取车道线
使用`paddleseg`进行训练，选择轻量级模型保证不影响巡航速度。

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/1.png" alt="车道线提取效果" style="zoom:50%;" />

### 训练巡航模型
采用官方方案，在训练前将提取车道线。

### 部署
为常用的速度设置对应pid，确保全程可以使用不同的速度准确定位任务点并稳定巡航。

## 抓取方块&放下方块
小车执行方块任务时，机械臂从置物平台上抓取和放置方块花费的时间比较长，往往是小车已经到达任务点，但仍在等待机械臂就位。为此对抓夹进行了改进，使其能够一次性抓取两个物料，最终显著提升了执行方块任务时的速度。

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/2.png" alt="修改后的抓夹(比较潦草)" style="zoom: 25%;" />

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/3.png" style="zoom: 100%;" />

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/4.png" style="zoom: 67%;" />




## 抓取小球&放下小球
主要做了三处修改(提速不多)：

1. 去除轨道前段水平连接杆，防止小球放入时卡住；
2. 缩短内侧栏杆的长度并降低其高度，方便机械臂更快的把小球放入平台；
3. 在内侧栏杆上系上扎带，为放下小球提供缓冲(可以确保小球稳定地落入物资发放区)；

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/5.png" alt="修改后的置物平台" style="zoom:33%;" />

## 通信抢修&神秘任务&高空排险
两个基础任务只要确保定位准确就不会有问题，这两个任务的模型都有至少两个可供红外检测的柱子，于是，我们将定位分为两个阶段，第一阶段保持高速到达任务起始点，第二阶段使用低速保证小车与任务模型之间的相对位置保持固定，这样既能保证任务完成的速度，又能确保操作的稳定性。

神秘任务，我们小车侧边红外有点高，没法检测到任务模型，所以采用相对信号塔偏移相对位置后放下小球的方案；

## 物资盘点
在小车刚过直角弯时就对任务方向进行检测，并开始执行机械臂初始化动作，以节省时间。

和抓取方块同样的处理方式也可以在该任务中使用，可以通过堆叠的方式收集2号蓝色圆柱和3号小型红色圆柱后再回到红色平板区域摆放，具体实现中加入了寻找对应圆柱时记录其他未操作圆柱位置的操作，以节省重复寻找的时间。

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/6.png" alt="收集两个圆柱后返回"  />

另外缩进了旋转信号塔舵机与红外传感器，防止蹭到放置圆柱的任务模型；

<img src="https://gitee.com/ryzquo/img_io/raw/master/bd_car2024/7.png" alt="缩进后的样子" style="zoom: 25%;" />

## 应急避险
在进入营地前对营地进行了定位，保证小车与营地间的相对位置保持固定，小车就可以稳定的停进红色区域；文本识别方面，我们在检测到文本区域后将其拼接成一行，再进行一次文本识别就可以获得完整的任务文本；在文本任务执行方面，我们根据文本内容，将其分为主要动作与次要动作，次要动作可以在主要动作执行时异步执行，可以节省一点时间；

## 扫黑除暴
如果对每个人物都进行一次定位，任务执行时间会大幅增加。为此，我们仅对第一个人物进行精确定位，后续人物只需根据相对距离进行移动。然而在测试中我们发现，第一个人物的宽度会存在不一致的情况，这时小车与后续人物的相对位置容易发生偏移，从而影响小车击倒指定人物，为此我们取消了小车y方向的定位，仅使用人物的x坐标进行定位。这个方法显著提高了系统的稳定性，并且有效减少了任务执行时间。考虑到人物属性检测不准确的问题，我们实现了在没有找到完全匹配的罪犯时，根据匹配属性数量击倒匹配度最高的人物的功能，提高小车对异常情况的处理能力。

同时，我们重新训练了人物属性检测模型，以提高识别的速度与准确性。



